<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pseudomonas Eradication Therapy Evidence map v_0.053</title>
    <style type="text/css">
        .custom-button-container {
            display: inline-block;
        }

        .custom-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .custom-button:hover {
            background-color: #0056b3;
        }

        .hidden {
            display: none;
        }

        .Title {
            color: gray;
            height: 20px;
            font-size: 20px;
            font-family: Helvetica;
        }

        .Textbox {
            font-size: 15px;
            font-family: Helvetica;
            padding: 5px;
            text-align: left;
            float: left;
            height: 20px;
            border-radius: 15px;
        }
    </style>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>
    <script type="text/javascript">
        // Evidence map version 0.053
        // TODO
        ////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////
        console.log("initiating variables");

        //  INITIAL VARIABLES:
        var svgNS = "http://www.w3.org/2000/svg";  // initiates the namespace


        // these two variable store the data:-
        var dataset = []
        var dataset_links = []

        var dataset = [
            {
                "\ufeff+": "0",
                "title": "G0",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://clinicaltrials.gov/study/NCT03219164",
                "recommend": "The primary objective of this study is to evaluate the safety and efficacy of a 14-day course versus a 28-day course of aztreonam for inhalation solution (AZLI) in pediatric participants with new onset Pseudomonas aeruginosa respiratory tract infection or colonization.",
                "full_title": "Study of aztreonam for inhalation in children with cystic fibrosis and new Infection of the airways by pseudomonas aeruginosa bacteria (ALPINE 2) (2017): https://clinicaltrials.gov/study/NCT03219164"
            },
            {
                "\ufeff+": "1",
                "title": "G1",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://doi.org/10.1016/j.jcf.2018.04.002",
                "recommend": "Objective: Antibiotic eradication treatment is the standard-of-care for cystic fibrosis (CF) patients with early Pseudomonas aeruginosa (Pa)-\ninfection; however, evidence from placebo-controlled trials is limited. Methods: This double-blind, placebo-controlled trial randomised CF patients b7 years (N = 51) with early Pa-infection to tobramycin inhalation\nsolution (TOBI 300 mg) or placebo (twice daily) for 28 days with an optional cross-over on Day 35. Primary endpoint was proportion of patients\nhaving throat swabs/sputum free of Pa on Day 29.\nResults: On Day 29, 84.6% patients in the TOBI versus 24.0% in the placebo group were Pa-free (p b 0.001). At the end of the cross-over period,\n76.0% patients receiving TOBI in the initial 28 days were Pa-free compared to 47.8% receiving placebo initially. Adverse events were consistent\nwith the TOBI safety profile with no differences between TOBI and placebo.\nConclusion: TOBI was effective in eradicating early Pa-infection with a favourable safety profile in young CF patients.",
                "full_title": "Eradication of early P. aeruginosa infection in children <7years of age with cystic fibrosis: the early study (2019) doi: https://doi.org/10.1016/j.jcf.2018.04.002"
            },
            {
                "\ufeff+": "2",
                "title": "G2",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://doi.org10.1164/rccm.200208-855OC",
                "recommend": "We conducted a double-blind, placebo-controlled, multicenter, randomized trial to test the hypothesis that 300 mg of tobramycin solution for inhalation administered twice daily for 28 days would be safe and result in a profound decrease in Pseudomonas aeruginosa (Pa) density from the lower airway of young children with cystic fibrosis. Ninety-eight subjects were to be randomized; however, the trial was stopped early because of evidence of a significant microbiological treatment effect. Twenty-one children under age 6 years were randomized (8 active; 13 placebo) and underwent bronchoalveolar lavage at baseline and on Day 28. There was a significant difference between treatment groups in the reduction in Pa density; no Pa was detected on Day 28 in 8 of 8 active group patients compared with 1 of 13 placebo group patients. We observed no differences between treatment groups for clinical indices, markers of inflammation, or incidence of adverse events. No abnormalities in serum creatinine or audiometry and no episodes of significant bronchospasm were observed in association with active treatment. We conclude that 28 days of tobramycin solution for inhalation of 300 mg twice daily is safe and effective for significant reduction of lower airway Pa density in young children with cystic fibrosis.",
                "full_title": "Significant microbiological effect of inhaled tobramycin in young children with cystic fibrosis (2003) doi: https://doi.org10.1164/rccm.200208-855OC"
            },
            {
                "\ufeff+": "3",
                "title": "G3",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://doi.org/10.1164/rccm.201802-0215OC\u00a0\u00a0",
                "recommend": "Rationale: New isolation of Pseudomonas aeruginosa (Pa) is generally treated with inhaled antipseudomonal antibiotics such as tobramycin inhalation solution (TIS). A therapeutic approach that complements traditional antimicrobial therapy by reducing the risk of pulmonary exacerbation and inflammation may ultimately prolong the time to Pa recurrence.\n\nObjectives: To test the hypothesis that the addition of azithromycin to TIS in children with cystic fibrosis and early Pa decreases the risk of pulmonary exacerbation and prolongs the time to Pa recurrence.\n\nMethods: The OPTIMIZE (Optimizing Treatment for Early Pseudomonas aeruginosa Infection in Cystic Fibrosis) trial was a multicenter, double-blind, randomized, placebo-controlled, 18-month trial in children with CF, 6 months to 18 years of age, with early Pa. Azithromycin or placebo was given 3\u00d7 weekly with standardized TIS.\n\nMeasurements and Main Results: The primary endpoint was the time to pulmonary exacerbation requiring antibiotics and the secondary endpoint was the time to Pa recurrence, in addition to other clinical and safety outcomes. A total of 221 participants (111 placebo, 110 azithromycin) out of a planned 274 were enrolled. Enrollment was stopped early by the NHLBI because the trial had reached the prespecified interim boundary for efficacy. The risk of pulmonary exacerbation was reduced by 44% in the azithromycin group as compared with the placebo group (hazard ratio, 0.56; 95% confidence interval, 0.37\u20130.83; P\u2009=\u20090.004). Weight increased by 1.27 kg in the azithromycin group compared with the placebo group (95% confidence interval, 0.01\u20132.52; P\u2009=\u20090.046). No significant differences were seen in microbiological or other clinical or safety endpoints.\n\nConclusions: Azithromycin was associated with a significant reduction in the risk of pulmonary exacerbation and a sustained improvement in weight, but had no impact on microbiological outcomes in children with early Pa.\n\nClinical trial registered with clinicaltrials.gov (NCT02054156).",
                "full_title": "Azithromycin for Early Pseudomonas Infection in Cystic Fibrosis. The OPTIMIZE Randomized Trial (2018) doi: https://doi.org/10.1164/rccm.201802-0215OC\u00a0\u00a0"
            },
            {
                "\ufeff+": "4",
                "title": "G4",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://doi.org/10.1016/j.jcf.2012.06.001",
                "recommend": "Abstract\nIn patients with cystic fibrosis (CF), treatment of new Pseudomonas aeruginosa (Pa) infection postpones the occurrence of chronic infection, but the best eradication regimen is unknown .\n\nAim of the study\nCompare 2 Pa eradication regimens in children with new Pa infection.\n\nMethods\nChildren with CF (0\u201318 years) and a new isolation of Pa from sputum, cough swab or BAL were randomized to treatment with tobramycin inhalation solution for 28 days (TIS) or inhaled sodiumcolistimethate (2 \u00d7 2 mill U/day) plus oral ciprofloxacin (30 mg/kg/day) for 3 months (CC). Airway cultures were taken for 6 consecutive months, then every 3 months. The primary outcome was Pa eradication at the end of treatment. Secondary outcome parameters were: time to Pa relapse from end of treatment, total and Pa specific IgG, FEV1, BMI and Pa status at 2 year follow-up.\n\nResults\n58 patients with new Pa isolation were randomized. Their median age was 9 years (IQR 4.7\u201313.1) and their median FEV1 98% predicted (IQR 87\u2013107). Eighteen treatments concerned the first Pa isolation \u2018ever\u2019 (TIS: 8; CC: 10). For the remaining, median time since previous Pa was 19 months (IQR 9\u201341). Eradication at end of treatment was similar for both treatments: 26/29 CC and 23/29 in TOBI treated patients (p = 0.47). Median time to recurrence of Pa was 9 months (95% CI 0.0\u201319.0) for CC and 5 months (95% CI 1.7\u20138.3) for TIS (p = 0.608). After 1 year, the 2 groups did not differ in change in total and Pa specific IgG, FEV1 and BMI. After 2 years, 10% of patients had chronic Pa infection.\n\nConclusion\nIn children with CF and new Pa infection, inhalation of TIS (28 days) or CC (3 months) resulted in similar eradication success at the end of treatment (80 and 90% respectively) and similar clinical evolution during the first 2 years of follow-up.",
                "full_title": "Comparison of two treatment regimens for eradication of Pseudomonas aeruginosa infection in children with cystic fibrosis (2013) doi: https://doi.org/10.1016/j.jcf.2012.06.001"
            },
            {
                "\ufeff+": "5",
                "title": "G5",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://doi.org/10.1136/thx.2009.121657",
                "recommend": "Abstract\nRationale Antibiotic therapy for early Pseudomonas aeruginosa infection in patients with cystic fibrosis (CF) is effective, but the optimal therapeutic regimen and duration for early treatment remains unclear. The EarLy Inhaled Tobramycin for Eradication (ELITE) study was designed to assess the efficacy and safety of two regimens (28 and 56\u2005days) of tobramycin inhalation solution (TIS) 300\u2005mg/5\u2005ml twice daily for the treatment of early onset P aeruginosa infection in patients with CF.\n\nMethods In this open-label randomised multicentre study, patients with CF (aged \u22656\u2005months) with early P aeruginosa infection were treated for 28\u2005days with TIS twice daily administered by the PARI LC PLUS (PARI GmbH, Starnberg, Germany) jet nebuliser. After 28\u2005days, patients were randomised 1:1 to either stop TIS (n=45) or to receive a further 28\u2005days of TIS (n=43). The primary endpoint was the median time to recurrence of P aeruginosa (any strain). Secondary endpoints included the proportion of patients free of P aeruginosa infection 1\u2005month after cessation of therapy and safety assessments.\n\nResults The median time to recurrence of P aeruginosa (any strain) was similar between the two groups. In total, 93% and 92% of the patients were free of P aeruginosa infection 1\u2005month after the end of treatment and 66% and 69% remained free at the final visit in the 28-day and 56-day groups, respectively. TIS was well tolerated.\n\nConclusions Treatment with TIS for 28\u2005days is an effective and well tolerated therapy for early P aeruginosa infection in patients with CF.\n\nTrial registration number NCT00391976.",
                "full_title": "Treatment of early Pseudomonas aeruginosa infection in patients with cystic fibrosis: the ELITE trial (2010) doi: https://doi.org/10.1136/thx.2009.121657"
            },
            {
                "\ufeff+": "6",
                "title": "G6",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://doi.org/10.1136/thoraxjnl-2011-200832",
                "recommend": "Abstract\nBackground Pseudomonas aeruginosa chronic pulmonary infection is an unfavourable event in cystic fibrosis. Bacterial clearance is possible with an early antibiotic treatment upon pathogen isolation. Currently, no best practice exists for early treatment. The efficacy of two different regimens against initial P aeruginosa infection was assessed.\n\nMethods In a randomised, open-label, parallel-group study involving 13 centres, the superiority of inhaled tobramycin/oral ciprofloxacin compared with inhaled colistin/oral ciprofloxacin (reference treatment) over 28\u2005days was evaluated. Patients were eligible if they were older than 1\u2005year with first or new P aeruginosa isolation. Treatments were assigned equally by centralised balanced randomisation, stratified by age and forced expiratory volume in 1 s values. The participants and those giving the intervention were not masked to arm assignments. The primary endpoint was P aeruginosa eradication, defined as three successive negative cultures in 6\u2005months. Analysis was by intention to treat. This trial was registered with EudraCT, number 2008-006502-42.\n\nResults 105 patients were assigned to inhaled colistin/oral ciprofloxacin (arm A) and 118 to inhaled tobramycin/oral ciprofloxacin (arm B). All patients were analysed. P aeruginosa was eradicated in 66 (62.8%) patients in arm A and in 77 (65.2%) in arm B (OR 0.90, 95% CI 0.52 to 1.55, p=0.81). Following treatment, an increase in Stenotrophomonas maltophilia was noted (OR 3.97, 95% CI 2.27 to 6.94, p=0.001) with no differences between the two arms (OR 0.89, 95% CI 0.44 to 1.78, p=0.88).\n\nConclusions No superiority of treatment under study was demonstrated in comparison to the reference treatment. Early eradication treatment was associated with an increase in S maltophilia.",
                "full_title": "Early antibiotic treatment for Pseudomonas aeruginosa eradication in patients with cystic fibrosis: a randomised multicentre study comparing two different protocols (2012) doi: https://doi.org/10.1136/thoraxjnl-2011-200832"
            },
            {
                "\ufeff+": "7",
                "title": "G7",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "https://doi.org/10.1016/S2213-2600(20)30331-3",
                "recommend": "Background\nChronic pulmonary infection with Pseudomonas aeruginosa is one of the most important causes of mortality and morbidity in cystic fibrosis. If antibiotics are commenced promptly, infection can be eradicated. The aim of the trial was to compare the effectiveness and safety of intravenous ceftazidime and tobramycin versus oral ciprofloxacin in the eradication of P aeruginosa.\n\nMethods\nWe did a multicentre, parallel group, open-label, randomised controlled trial in 72 cystic fibrosis centres (70 in the UK and two in Italy). Eligible participants were older than 28 days with an isolate of P aeruginosa (either the first ever isolate or a new isolate after at least 1 year free of infection). Participants were excluded if the P aeruginosa was resistant to, or they had a contraindication to, one or more of the trial antibiotics; if they were already receiving P aeruginosa suppressive therapy; if they had received any P aeruginosa eradication therapy within the previous 9 months; or if they were pregnant or breastfeeding. We used web-based randomisation to assign patients to 14 days intravenous ceftazidime and tobramycin or 12 weeks oral ciprofloxacin. Both were combined with 12 weeks inhaled colistimethate sodium. Randomisation lists were generated by a statistician, who had no involvement in the trial, using a computer-generated list. Randomisation was stratified by centre and because of the nature of the interventions, blinding was not possible. Our primary outcome was eradication of P aeruginosa at 3 months and remaining free of infection to 15 months. Primary analysis used intention to treat (powered for superiority). Safety analysis included patients who received at least one dose of study drug. TORPEDO-CF was registered on the ISRCTN register, ISRCTN02734162, and EudraCT, 2009-012575-10.\n\nFindings\nBetween Oct 5, 2010, and Jan 27, 2017, 286 patients were randomly assigned to treatment: 137 to intravenous antibiotics and 149 to oral antibiotics. 55 (44%) of 125 participants in the intravenous group and 68 (52%) of 130 participants in the oral group achieved the primary outcome. Participants randomly assigned to the intravenous group were less likely to achieve the primary outcome, although the difference between groups was not statistically significant (relative risk 0\u00b784, 95% CI 0\u00b765\u20131\u00b709; p=0\u00b718). 11 serious adverse events occurred in ten (8%) of 126 participants in the intravenous antibiotics group and 17 serious adverse events in 12 (8%) of 146 participants in the oral antibiotics group.\n\nInterpretation\nCompared with oral therapy, intravenous antibiotics did not achieve sustained eradication of P aeruginosa in a greater proportion of patients with cystic fibrosis and was more expensive. Although there were fewer hospitalisations in the intravenous group than the oral group during follow-up, this confers no advantage over oral treatment because intravenous eradication frequently requires hospitalisation. These results do not support the use of intravenous antibiotics to eradicate P aeruginosa in cystic fibrosis.",
                "full_title": "Intravenous versus oral antibiotics for eradication of Pseudomonas aeruginosa in cystic fibrosis (TORPEDO-CF): a randomised controlled trial (2020) doi: https://doi.org/10.1016/S2213-2600(20)30331-3"
            },
            {
                "\ufeff+": "8",
                "title": "G8",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "10.1001/archpediatrics.2011.136",
                "recommend": "Abstract\nObjective: To investigate the efficacy and safety of 4 antipseudomonal treatments in children with cystic fibrosis with recently acquired Pseudomonas aeruginosa infection.\n\nDesign: Randomized controlled trial.\n\nSetting: Multicenter trial in the United States.\n\nParticipants: Three hundred four children with cystic fibrosis aged 1 to 12 years within 6 months of P aeruginosa detection.\n\nInterventions: Participants were randomized to 1 of 4 antibiotic regimens for 18 months (six 12-week quarters) between December 2004 and June 2009. Participants randomized to cycled therapy received tobramycin inhalation solution (300 mg twice a day) for 28 days, with oral ciprofloxacin (15-20 mg/kg twice a day) or oral placebo for 14 days every quarter, while participants randomized to culture-based therapy received the same treatments only during quarters with positive P aeruginosa cultures.\n\nMain outcome measures: The primary end points were time to pulmonary exacerbation requiring intravenous antibiotics and proportion of P aeruginosa -positive cultures.\n\nResults: The intention-to-treat analysis included 304 participants. There was no interaction between treatments. There were no statistically significant differences in exacerbation rates between cycled and culture-based groups (hazard ratio, 0.95; 95% confidence interval [CI], 0.54-1.66) or ciprofloxacin and placebo (hazard ratio, 1.45; 95% CI, 0.82-2.54). The odds ratios of P aeruginosa- positive culture comparing the cycled vs culture-based group were 0.78 (95% CI, 0.49-1.23) and 1.10 (95% CI, 0.71-1.71) comparing ciprofloxacin vs placebo. Adverse events were similar across groups.\n\nConclusions: No difference in the rate of exacerbation or prevalence of P aeruginosa positivity was detected between cycled and culture-based therapies. Adding ciprofloxacin produced no benefits.\n\nTrial registration: ClinicalTrials.gov Identifier: NCT00097773.",
                "full_title": "Comparative efficacy and safety of 4 randomized regimens to treat early Pseudomonas aeruginosa infection in children with cystic fibrosis (2011) doi: 10.1001/archpediatrics.2011.136"
            },
            {
                "\ufeff+": "9",
                "title": "G9",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "10.1016/0140-6736(91)91446-2",
                "recommend": "To assess whether chronic pulmonary colonisation with Pseudomonas aeruginosa in cystic fibrosis is preventable, 26 patients who had never received anti-pseudomonas chemotherapy were randomly allocated to groups receiving either no anti-pseudomonas chemotherapy or oral ciprofloxacin and aerosol inhalations of colistin twice daily for 3 weeks, whenever Ps aeruginosa was isolated from routine sputum cultures. During the 27 months of the trial, infection with Ps aeruginosa became chronic in significantly fewer treated than untreated subjects (2 [14%] vs 7 [58%]; p less than 0.05) and there were significantly fewer Ps aeruginosa isolates in routine sputum cultures in the treated group (49/214 [23%] vs 64/158 [41%]; p = 0.0006). Thus, chronic colonisation with Ps aeruginosa can be prevented in cystic fibrosis by early institution of anti-pseudomonas chemotherapy.",
                "full_title": "Prevention of chronic Pseudomonas aeruginosa colonisation in cystic fibrosis by early treatment. (1991) doi: 10.1016/0140-6736(91)91446-2"
            },
            {
                "\ufeff+": "10",
                "title": "G10",
                "size": 1,
                "group": 0,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "10.1002/(sici)1099-0496(199802)25:2<88::aid-ppul3>3.0.co;2-j",
                "recommend": "In chronic Pseudomonas aeruginosa pulmonary infection of patients with cystic fibrosis (CF), antibiotic therapy generally fails to eradicate the bacterial pathogen. The mucoid bacterial phenotype, high sputum production by the host, and low airway levels of antibiotics seem to be responsible for the observed decrease in antibiotic efficacy. We hypothesized that early antibiotic treatment by inhalation in CF patients may be able to prevent or at least delay airway infection. In a prospective placebo-controlled, double-blind, randomized multicenter study, 22 CF patients received either 80 mg b.i.d. of aerosolized tobramycin or placebo for a period of 12 months shortly after the onset of P. aeruginosa pulmonary colonization. Two patients in the tobramycin and six patients in the placebo group stopped inhalation before the 12 month treatment period. Using life table analysis, the time to conversion from a P. aeruginosa-positive to a P. aeruginosa-negative respiratory culture was significantly shorter in the tobramycin-treated group than in the placebo group (P < 0.05, log rank test). Lung function parameters and markers of inflammation did not change in either group during treatment. The results of this study suggest that early tobramycin inhalation may prevent and/or delay P. aeruginosa pulmonary infection in CF patients.",
                "full_title": "Placebo-controlled, double-blind, randomised study of aerosolised tobramycin for early treatment of Pseudomonas aeruginosa colonization in cystic fibrosis (1998) 10.1002/(sici)1099-0496(199802)25:2<88::aid-ppul3>3.0.co;2-j"
            },
            {
                "\ufeff+": "11",
                "title": "SR0",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Eradication of P aeruginosa from the respiratory tract"
            },
            {
                "\ufeff+": "12",
                "title": "SR1",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Mortality"
            },
            {
                "\ufeff+": "13",
                "title": "SR2",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Quality of Life"
            },
            {
                "\ufeff+": "14",
                "title": "SR3",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Lung function"
            },
            {
                "\ufeff+": "15",
                "title": "SR4",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Growth and nutritional status"
            },
            {
                "\ufeff+": "16",
                "title": "SR5",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Frequency of pulmonary exacerbations"
            },
            {
                "\ufeff+": "17",
                "title": "SR6",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Isolation of other micro-organisms"
            },
            {
                "\ufeff+": "18",
                "title": "SR7",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Adverse effects of antibiotics"
            },
            {
                "\ufeff+": "19",
                "title": "SR8",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Time to chromic infection"
            },
            {
                "\ufeff+": "20",
                "title": "SR9",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Clinical and radiological scores"
            },
            {
                "\ufeff+": "21",
                "title": "SR10",
                "size": 1,
                "group": 1,
                "x_coord": 0,
                "y_coord": 0,
                "rad": 0,
                "doi": "",
                "recommend": "",
                "full_title": "Cost effectiveness"
            }
            ];


        var dataset_links = [
            {
                "\ufeff": "0",
                "origin": "G0",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "1",
                "origin": "G0",
                "termination": "SR8",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Time to chronic infection / next isolation",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "2",
                "origin": "G0",
                "termination": "SR1",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Mortality",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "3",
                "origin": "G0",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "4",
                "origin": "G1",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "5",
                "origin": "G2",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "6",
                "origin": "G2",
                "termination": "SR4",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Growth and nutritional status",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "7",
                "origin": "G2",
                "termination": "SR6",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Isolation of other micro-organisms",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "8",
                "origin": "G2",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "9",
                "origin": "G2",
                "termination": "SR9",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Clinical and radiological scores",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "10",
                "origin": "G3",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "11",
                "origin": "G3",
                "termination": "SR8",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Time to chronic infection / next isolation",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "12",
                "origin": "G3",
                "termination": "SR1",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Mortality",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "13",
                "origin": "G3",
                "termination": "SR3",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Lung function",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "14",
                "origin": "G3",
                "termination": "SR4",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Growth and nutritional status",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "15",
                "origin": "G3",
                "termination": "SR5",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Frequency of pulmonary exacerbations",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "16",
                "origin": "G3",
                "termination": "SR6",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Isolation of other micro-organisms",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "17",
                "origin": "G3",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "18",
                "origin": "G4",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "19",
                "origin": "G4",
                "termination": "SR1",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Mortality",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "20",
                "origin": "G4",
                "termination": "SR3",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Lung function",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "21",
                "origin": "G4",
                "termination": "SR4",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Growth and nutritional status",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "22",
                "origin": "G4",
                "termination": "SR5",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Frequency of pulmonary exacerbations",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "23",
                "origin": "G4",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "24",
                "origin": "G5",
                "termination": "SR8",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Time to chronic infection / next isolation",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "25",
                "origin": "G5",
                "termination": "SR1",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Mortality",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "26",
                "origin": "G5",
                "termination": "SR3",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Lung function",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "27",
                "origin": "G5",
                "termination": "SR4",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Growth and nutritional status",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "28",
                "origin": "G5",
                "termination": "SR5",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Frequency of pulmonary exacerbations",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "29",
                "origin": "G5",
                "termination": "SR6",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Isolation of other micro-organisms",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "30",
                "origin": "G5",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "31",
                "origin": "G6",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "32",
                "origin": "G6",
                "termination": "SR1",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Mortality",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "33",
                "origin": "G6",
                "termination": "SR3",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Lung function",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "34",
                "origin": "G6",
                "termination": "SR6",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Isolation of other micro-organisms",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "35",
                "origin": "G6",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "36",
                "origin": "G7",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "37",
                "origin": "G7",
                "termination": "SR8",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Time to chronic infection / next isolation",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "38",
                "origin": "G7",
                "termination": "SR1",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Mortality",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "39",
                "origin": "G7",
                "termination": "SR2",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Quality of Life",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "40",
                "origin": "G7",
                "termination": "SR3",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Lung function",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "41",
                "origin": "G7",
                "termination": "SR4",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Growth and nutritional status",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "42",
                "origin": "G7",
                "termination": "SR5",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Frequency of pulmonary exacerbations",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "43",
                "origin": "G7",
                "termination": "SR6",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Isolation of other micro-organisms",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "44",
                "origin": "G7",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "45",
                "origin": "G7",
                "termination": "SR10",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Cost effectiveness",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "46",
                "origin": "G8",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "47",
                "origin": "G8",
                "termination": "SR1",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Mortality",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "48",
                "origin": "G8",
                "termination": "SR3",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Lung function",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "49",
                "origin": "G8",
                "termination": "SR4",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Growth and nutritional status",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "50",
                "origin": "G8",
                "termination": "SR5",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Frequency of pulmonary exacerbations",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "51",
                "origin": "G8",
                "termination": "SR6",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Isolation of other micro-organisms",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "52",
                "origin": "G8",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "53",
                "origin": "G9",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "54",
                "origin": "G9",
                "termination": "SR8",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Time to chronic infection / next isolation",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "55",
                "origin": "G10",
                "termination": "SR0",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Eradication of P aeruginosa from the respiratory tract",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "56",
                "origin": "G10",
                "termination": "SR3",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Lung function",
                "line_style": 1,
                "agreement": 1
            },
            {
                "\ufeff": "57",
                "origin": "G10",
                "termination": "SR7",
                "commission": "",
                "otherEvidence": "",
                "line_col": 1,
                "line_opaque": 1,
                "topic": "Adverse effects of antibiotics",
                "line_style": 1,
                "agreement": 1
            }
            ];
      
        ////////////////////////////////////////////////////////////////

        var w = window.innerWidth;
        var h = window.innerHeight - 110; // 110 is needed for the results table and the buttons
        var popup_w = 2 * w / 5 - 20;
        var popup_h = h / 3;  // previously this was:  h / 3 + 100;
        var circle_radius = 50;

        var line_width = 8;
        var line_dashed = "30, 10";

        var link_gap = 7;

        // define svg and diagonal as global 
        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);
        console.log("svg defined");

        var diagonal = d3.svg.diagonal()
            // this sets up a variable containing
            // the diagonal function
            // note that the x and y are swapped round and then
            // swapped back with the .projection -
            // this is so that the diagonal curves in the right direction
            .source(function (d) {
                return {
                    "y": getXcoord(d.origin) + getRadius(d.origin) + link_gap,
                    "x": getYcoord(d.origin)
                };
            })
            .target(function (d) {
                return {
                    "y": getXcoord(d.termination) - getRadius(d.termination) - link_gap,
                    "x": getYcoord(d.termination)
                };
            })
            .projection(function (d) { return [d.y, d.x]; });

        

        // colours:-
        var left_outer_colour = "rgb(0, 101, 121)";
        var left_inner_colour = "rgb(0, 149, 161)";
        var left_lighter_colour = "rgb(100, 205, 205)";
        var left_faded_colour = "rgba(100, 205, 205, 0.5)"

        var right_outer_colour = "rgb(91, 41, 96)";
        var right_inner_colour = "rgb(145, 30, 179)";
        var right_lighter_colour = "rgb(199, 134, 219)";
        var right_faded_colour = "rgba(199, 134, 219, 0.2)"

        var link_highlight_colour = "rgb(0, 51, 102)"; // corp blue
        var link_standard_colour = "rgba(0, 51, 102, 0.4)";
        var link_faded_colour = "rgba(0, 51, 102, 0.1)";

        var link_highlight_colour_disagree = "rgb(136, 42, 13)"; //Arts dark
        var link_standard_colour_disagree = "rgba(136, 42, 13, 0.4)";
        var link_faded_colour_disagree = "rgba(136, 42, 13, 0.1)";

        var link_transparent_colour = "rgba(0, 0, 0, 0.0)"; // fully transparent

        var button_width = 220;
        var margin = 100; // distance from left button width 

        var group_3 = 0;
        var group_1 = 0;
        var group_0 = 0;

        var Antibiotic_therapy_col = "rgba(184, 204, 228, 1.0)"
        var Exacerbation_management_col = "rgba(184, 204, 228, 1.0)"
        var Pseudomonas_aeruginosa_col = "rgba(184, 204, 228, 1.0)"
        var Burkholderia_species_col = "rgba(184, 204, 228, 1.0)"
        var NTM_col = "rgba(184, 204, 228, 1.0)"
        var Stenotrophomonas_maltophilia_col = "rgba(184, 204, 228, 1.0)"
        var MRSA_col = "rgba(184, 204, 228, 1.0)"
        var Pneumococcus_col = "rgba(184, 204, 228, 1.0)"
        var Specific_Antibiotics_col = "rgba(184, 204, 228, 1.0)"
        var Antibiotic_prophylaxis_col = "rgba(184, 204, 228, 1.0)"
        var Inhaled_Antibiotics_col = "rgba(184, 204, 228, 1.0)"
        var Adjuncts_to_antibiotic_therapy_col = "rgba(184, 204, 228, 1.0)"
        var Management_of_ABPA_col = "rgba(184, 204, 228, 1.0)"
        var Viral_infections_col = "rgba(184, 204, 228, 1.0)"
        var Inflammation_col = "rgba(184, 204, 228, 1.0)"
        var Mucoactive_agents_col = "rgba(184, 204, 228, 1.0)"
        var Bronchodilators_col = "rgba(184, 204, 228, 1.0)"
        var Nebuliser_systems_col = "rgba(184, 204, 228, 1.0)"
        var NIV_col = "rgba(184, 204, 228, 1.0)"
        var Oxygen_col = "rgba(184, 204, 228, 1.0)"
        var Surgical_col = "rgba(184, 204, 228, 1.0)"
        var Pancreatic_Enzymes_col = "rgba(204, 192, 217, 1.0)"
        var Liver_disease_col = "rgba(204, 192, 217, 1.0)"
        var Nutritional_supplements_col = "rgba(204, 192, 217, 1.0)"
        var Appetite_col = "rgba(204, 192, 217, 1.0)"
        var Acid_management = "rgba(204, 192, 217, 1.0)"
        var Exercise_col = "rgba(214, 227, 188, 1.0)"
        var Physiotherapy_col = "rgba(214, 227, 188, 1.0)"
        var CF_related_arthritis_col = "rgba(251, 212, 180, 1.0)"
        var Osteoporosis_col = "rgba(251, 212, 180, 1.0)"
        var CF_related_diabetes_col = "rgba(182, 221, 232, 1.0)"
        var Growth_Hormone_col = "rgba(182, 221, 232, 1.0)"
        var Correction_of_basic_defect_col = "rgba(148, 54, 52, 1.0)"
        var Psychosocial_col = "rgba(166, 166, 166, 1.0)"
        var ENT_col = "rgba(150, 50, 102, 1.0)"

        // FUNCTION DEFINITIONS

        // Add this function to calculate maximum button width
        function calculateMaxButtonWidth() {
            // Define the padding you want on each side
            var padding = 20;
            
            // Create a temporary SVG text element for measurement
            var tempText = svg.append("text")
                .attr("font-family", "Helvetica")
                .attr("font-size", "14px")
                .style("opacity", 0); // Make it invisible
            
            var maxWidth = 0;
            
            // First collect all possible button texts
            var buttonTexts = [];
            
            // Get unique topics from dataset_links
            var uniqueTopics = [];
            for (var i = 0; i < dataset_links.length; i++) {
                var topic = dataset_links[i].topic;
                if (!uniqueTopics.includes(topic)) {
                    uniqueTopics.push(topic);
                    buttonTexts.push(topic);
                }
            }
            
            // Add other button texts
            buttonTexts.push("Reset");
            // Add any other fixed button texts here
            
            // Measure each text and find the maximum width
            for (var i = 0; i < buttonTexts.length; i++) {
                tempText.text(buttonTexts[i]);
                var width = tempText.node().getComputedTextLength();
                if (width > maxWidth) {
                    maxWidth = width;
                }
            }
            
            // Remove the temporary text element
            tempText.remove();
            
            // Calculate button width with padding
            var buttonWidth = maxWidth + (padding * 2);
            
            // Return the calculated width
            return buttonWidth;
        }

        function popupBottomText(page_number) {
            // function to popup the title of the 
            var coords = [0, 0];
            var dx = w / 2 - 50;
            var dy = h - 100;

            var rectangle = svg.append("rect")
                .attr("x", dx)
                .attr("y", dy)
                .attr("width", 100) // make it wide but 40 less than the current width
                .attr("height", 100)
                .attr("fill", function () {
                    return (left_faded_colour);
                })
                .attr("rx", 50)
                .attr("ry", 50)
                .attr("id", "popup_bottom_text")
                .style("pointer-events", "none")
                .on("click", function (d) {
                    page_number = page_number + 1;
                    removeBottomText();
                    removePopup();
                    writePage(page_number);
                });
            var rectangle = svg.append("rect")
                .attr("x", w - (150 + 5))
                .attr("y", h - (100 + 5))
                .attr("width", 140) //
                .attr("height", 100)
                .attr("fill", function () {
                    return (left_faded_colour);
                })
                .attr("rx", 50)
                .attr("ry", 50)
                .attr("id", "popup_bottom_text")
                .style("pointer-events", "none")
                .on("click", function (d) {
                    page_number = 12;
                    removeBottomText();
                    removePopup();
                    writePage(page_number);
                });

            var bottomText = svg.append("text")
                .attr('style', 'text-align:center; font-family:Helvetica; font-size:20px;')
                .attr("x", dx + 8)
                .attr("y", dy + 55)
                .attr('id', 'bottom_text')
                .text(function (d) {
                    var str = ("Continue");
                    return (str);
                })
                .style("cursor", "default");
            bottomText.on("click", function (d) {
                // if (page_number > )
                page_number = page_number + 1;
                // console.log(page_number);
                removeBottomText();
                removePopup();
                writePage(page_number);
            });
            var bottomText = svg.append("text")
                .attr('style', 'text-align:center; font-family:Helvetica; font-size:20px;')
                .attr("x", w - 130)
                .attr("y", h - 50)
                .attr('id', 'bottom_text')
                .text(function (d) {
                    var str = ("Skip intro...");
                    return (str);
                })
                .style("cursor", "default");
            bottomText.on("click", function (d) {
                // if (page_number > )
                page_number = 12;
                // console.log(page_number);
                removeBottomText();
                removePopup();
                writePage(page_number);
            });
        }

        function removePopup() {
            svg.selectAll("rect").remove();
            svg.selectAll("foreignObject").remove();
            svg.selectAll("xhtml").remove();
            var element = document.getElementById("multiline-title-text");
            if (element != null) {
                element.parentNode.removeChild(element);
            }
            var element = document.getElementById("bottom_text");
            element.parentNode.removeChild(element);
        }

        function popupBelow(this_var, node) {
            var rectangle = svg.append("rect")
                .attr("x", w / 8)
                .attr("y", h / 2 + 50)
                .attr("width", w * 6 / 8)
                .attr("height", 50)
                .attr("fill", function (d) {
                    if (node.group == 1) {
                        return (right_lighter_colour)
                    } else {
                        return (left_lighter_colour)
                    }
                })
                .attr("id", "below_popup_id")
                .attr("rx", 20)
                .attr("ry", 20)
                .style("pointer-events", "none");
            var popup_below_text = svg.append("text")
                .attr('style', 'text-align:center; font-family:Helvetica; font-size:20px;')
                .attr("x", w / 8 + 20)
                .attr("y", h / 2 + 50 + 30)
                .attr('id', 'below_popup_text_id')
                .text(function (d) {
                    var str = (node.title);
                    return (str);
                });
        }

        function removePopupBelow(this_var, node) {
            var element = document.getElementById("below_popup_id");
            element.parentNode.removeChild(element);
            var element = document.getElementById("below_popup_text_id");
            element.parentNode.removeChild(element);
        }


        function getXcoord(node) {
            // function to get the x co-ordinate of the
            // node stored in dataset
            var x_coord = 0;
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title == node) {
                    x_coord = dataset[i].x_coord;
                }
            }
            return x_coord;
        }

        function getYcoord(node) {
            // function to get the y corordinate of the
            // node stored in dataset
            var y_coord = 0;
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title == node) {
                    y_coord = dataset[i].y_coord;
                }
            }
            return y_coord;
        }

        function getRadius(node) {
            // function to get the radius of the
            // node stored in dataset
            var rad = 0;
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title == node) {
                    rad = dataset[i].rad;
                }
            }
            return rad;
        }

        function highlightNodes(node) {
            for (i = 0; i < dataset_links.length; i++) {
                //change the colour variable in dataset_links
                if (dataset_links[i].origin == node || dataset_links[i].termination == node) {
                    dataset_links[i].line_col = "2";
                } else {
                    dataset_links[i].line_col = "0";
                }
            }
            svg.selectAll("#links")  //need to update the visuals - update all the paths
                .data(dataset_links)
                .style("stroke", function (d) {
                    if (d.line_opaque == 0) {
                        return (link_transparent_colour);
                    } else if (d.line_col == 1 && d.agreement == 1) {
                        return (link_standard_colour);
                    } else if (d.line_col == 1 && d.agreement == 4) {
                        return (link_standard_colour_disagree);
                    } else if (d.line_col == 0 && d.agreement == 1) {
                        return (link_faded_colour);
                    } else if (d.line_col == 0 && d.agreement == 4) {
                        return (link_faded_colour_disagree);
                    } else if (d.line_col == 2 && d.agreement == 1) {
                        return (link_highlight_colour);
                    } else if (d.line_col == 2 && d.agreement == 4) {
                        return (link_highlight_colour_disagree);
                    } else {
                        return ("blue");
                    }
                })
                ;
        }

        function unhighlightNodes() {
            for (i = 0; i < dataset_links.length; i++) {
                //reset the colours of all nodes
                dataset_links[i].line_col = "1";
            }
            svg.selectAll("#links")  //need to update the visuals - update all the paths
                .data(dataset_links)
                //.transition()
                //.duration(100)
                .style("stroke", function (d) {
                    if (d.line_opaque == 0) {
                        return (link_transparent_colour);
                    } else if (d.line_col == 1 && d.agreement == 1) {
                        return (link_standard_colour);
                    } else if (d.line_col == 1 && d.agreement == 4) {
                        return (link_standard_colour_disagree);
                    } else if (d.line_col == 0 && d.agreement == 1) {
                        return (link_faded_colour);
                    } else if (d.line_col == 0 && d.agreement == 4) {
                        return (link_faded_colour_disagree);
                    } else if (d.line_col == 2 && d.agreement == 1) {
                        return (link_highlight_colour);
                    } else if (d.line_col == 2 && d.agreement == 4) {
                        return (link_highlight_colour_disagree);
                    } else {
                        return ("blue");
                    }
                });
        }

        function fadeAllLinks() {
            //function to fade all the links
            svg.selectAll("#links")  //need to update the visuals - update all the paths
                .data(dataset_links)
                .style("stroke", function (d) {
                    if (d.line_opaque == 0) {
                        return (link_transparent_colour);
                    } else if (d.agreement == 1) {
                        return (link_faded_colour);
                    } else if (d.agreement == 4) {
                        return (link_faded_colour_disagree);
                    }
                })
                ;
        }

        function highlightLinks(link) {
            // function to highlight the link
            // and include the text in the upper boxes
            // first get the origin then
            // find the text associated with link.origin
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title == link.origin) {
                    insertLeftText(dataset[i].recommend);
                }
                if (dataset[i].title == link.termination) {
                    insertRightText(dataset[i].recommend);
                }
            }
        }

        function updateCircleLocation() {
            transition_time = typeof transition_time !== 'undefined' ? transition_time : 5000;
            svg.selectAll("#nodes")
                .data(dataset)
                .transition()
                .duration(transition_time)
                .attr("cx", function (d) {
                    return (d.x_coord);
                })
                .attr("cy", function (d) {
                    return (d.y_coord);
                });
        }

        function updateLineLocation(transition_time) {
            transition_time = typeof transition_time !== 'undefined' ? transition_time : 5000;
            svg.selectAll("#links")
                .data(dataset_links)
                .transition()
                .duration(transition_time)
                .attr("d", diagonal)
                .style("stroke", function (d) {
                    if (d.line_opaque == 0) {
                        return (link_transparent_colour);
                    } else if (d.line_col == 1 && d.agreement == 1) {
                        return (link_standard_colour);
                    } else if (d.line_col == 1 && d.agreement == 4) {
                        return (link_standard_colour_disagree);
                    } else if (d.line_col == 0 && d.agreement == 1) {
                        return (link_faded_colour);
                    } else if (d.line_col == 0 && d.agreement == 4) {
                        return (link_faded_colour_disagree);
                    } else if (d.line_col == 2 && d.agreement == 1) {
                        return (link_highlight_colour);
                    } else if (d.line_col == 2 && d.agreement == 4) {
                        return (link_highlight_colour_disagree);
                    } else {
                        return ("blue");
                    }
                });
        }

        function update_groups() {
            group_0 = 0;
            group_1 = 1;
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].group == 0) {
                    group_0 = group_0 + 1;
                } else if (dataset[i].group == 1) {
                    group_1 = group_1 + 1;
                }
            }
        }

        function setSquareArrangement() {
            // loop to empirically set the square node positions
            // note this calls and adjusts the global variables
            // first reset the data
            group_0_counter = 0;
            group_1_counter = 1;

            // Adjust these values to control the horizontal position
            var left_offset  = button_width + margin;  // Changed from w/3 to w/4 (smaller value = closer to center)
            var right_offset =  margin; // Changed from w/3 to w/4
            
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].group == 0) {
                    group_0_counter = group_0_counter + 1;
                    dataset[i].x_coord = left_offset;  // Use the new variable
                    dataset[i].y_coord = (group_0_counter) * (h * 0.9) / (group_0 + 1);

                } else if (dataset[i].group == 1) {
                    group_1_counter = group_1_counter + 1;
                    dataset[i].x_coord = w - right_offset;  // Use the new variable
                    dataset[i].y_coord = (group_1_counter) * (h * 0.9) / (group_1 + 1);
                }
            }
        }

        function setCircleArrangement() {
            // loop to set the circular node positions
            // note this calls and adjusts the global variables
            // makes use of group_0, and group_1
            // need to use group_1_counter and group_0_counter
            //   to keep track of the groups (in case they're 
            //   in funny orders)
            // circle offset is amount of the bottom and top of the circle to leave off
            // console.log("in set circle arangement");
            var circle_offset = 0.3;
            var separation = 50;
            var group_0_counter = Math.round(circle_offset / 2 * group_0);
            var group_1_counter = Math.round(circle_offset / 2 * group_1);
            var centre_x = w / 2 + button_width /2;
            var centre_y = h / 2;
            var left_offset  = button_width + margin;

            var radius_option1 = h * 0.45;  // Original height-based radius
            var radius_option2 = (w / 2) - (left_offset / 2); // Width-based radius considering buttons
            
            // Use the smaller of the two values
            var rad = Math.min(radius_option1, radius_option2) * 0.9;
            console.log("debugging setCicleArrangement");
            console.log(h);
            console.log(w);
            console.log(rad);
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].group == 0) {
                    dataset[i].x_coord = centre_x - separation - rad * Math.sin((group_0_counter * (3.14159265 / (group_0 + Math.round(circle_offset * group_0)))));
                    dataset[i].y_coord = centre_y - rad * Math.cos((group_0_counter * (3.14159265 / (group_0 + Math.round(circle_offset * group_0)))));
                    group_0_counter = group_0_counter + 1;
                } else if (dataset[i].group == 1) {
                    dataset[i].x_coord = centre_x + separation + (rad) * Math.sin((group_1_counter * (3.14159265 / (group_1 + Math.round(circle_offset * group_1)))));
                    dataset[i].y_coord = centre_y - (rad) * Math.cos((group_1_counter * (3.14159265 / (group_1 + Math.round(circle_offset * group_1)))));
                    group_1_counter = group_1_counter + 1;
                }
            }
        }

        function showAllSquare() {
            // make the nodes and links move into a square arrangement
            resetGroups();
            update_groups();
            setSquareArrangement();
            updateCircleLocation();
            updateLineLocation();
        }

        function showAllCircle() {
            resetGroups();
            update_groups();
            setCircleArrangement();
            updateCircleLocation();
            updateLineLocation();
        }

        function disAppearAllNodes() {
            // change the location of the nodes so that they are all off screen
            for (i = 0; i < dataset.length; i++) {
                dataset[i].y_coord = h + 200;
            }
            updateCircleLocation();
            updateLineLocation();
        }

        function getTopic(topic_string) {
            // console.log("In the getTopic() function")
            // console.log(topic_string)
            // function to put all the nodes in topic_string in, and put everyone else in group_2
            // first reset the data
            resetGroups(); // reset the groups
            // steps;
            // go through the dataset and set everyone to group 2 and move them all off screen

            for (let i = 0; i < dataset.length; i++) {
                dataset[i].group = 2;
                dataset[i].y_coord = h + 200;
            }
            // go through the dataset_links
            // for each row find if the topic == asthma
            for (let i = 0; i < dataset_links.length; i++) {
                if (dataset_links[i].topic == topic_string) {
                    // if topic is asthma get the guideline to group 1 and the cr to group 0
                    for (let j = 0; j < dataset.length; j++) {
                        if (dataset[j].title == dataset_links[i].origin) {
                            dataset[j].group = 0;
                        } else if (dataset[j].title == dataset_links[i].termination) {
                            dataset[j].group = 1;
                        }
                    }
                }
            }
            // reset the group variables and re_count the groups
            group_0 = 0;
            group_1 = 0;
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].group == 0) {
                    group_0 = group_0 + 1;
                } else if (dataset[i].group == 1) {
                    group_1 = group_1 + 1;
                }
            }
            changeColourExcludedGroups();
            setSquareArrangement();
            updateCircleLocation();
            updateLineLocation();
        }

        function getCommissioner(commission_string) {
            // function to put all the asthmas in, and put everyone else in group_2
            // first reset the data
            resetGroups(); // reset the groups
            // steps;
            // go through the dataset and set everyone to group 2 and move them all off screen

            for (i = 0; i < dataset.length; i++) {
                dataset[i].group = 2;
                dataset[i].y_coord = h + 200;
            }
            // go through the dataset_links
            // for each row find if the topic == asthma
            for (i = 0; i < dataset_links.length; i++) {
                if (dataset_links[i].commission == commission_string) {
                    // if commissioner is the right one get the guideline to group 1 and the cr to group 0
                    for (j = 0; j < dataset.length; j++) {
                        if (dataset[j].title == dataset_links[i].origin) {
                            dataset[j].group = 0;
                        } else if (dataset[j].title == dataset_links[i].termination) {
                            dataset[j].group = 1;
                        }
                    }
                }
            }
            // reset the group variables and re_count the groups
            group_0 = 0;
            group_1 = 0;
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].group == 0) {
                    group_0 = group_0 + 1;
                } else if (dataset[i].group == 1) {
                    group_1 = group_1 + 1;
                }
            }
            changeColourExcludedGroups();
            setCircleArrangement();
            updateCircleLocation();
            updateLineLocation();
        }

        function getDisagree() {
            // function to make all agreeing lines transparent

            for (i = 0; i < dataset_links.length; i++) {
                if (dataset_links[i].agreement == 1) {
                    dataset_links[i].line_opaque = 0;
                }
            }
            updateLineLocation(transition_time = 5000);
        }

        function getIgnored() {
            // function to show only the links with evidence ignored
            for (i = 0; i < dataset_links.length; i++) {
                if (dataset_links[i].line_style == 1) {
                    // remove the full lines
                    dataset_links[i].line_opaque = 0;
                }
            }
            updateLineLocation(transition_time = 5000);
        }

        function changeColourExcludedGroups() {
            for (i = 0; i < dataset_links["length"]; i++) {
                // loop over the dataset_links origins and terminations
                // if either are group 2 then set the line colour to 0
                for (j = 0; j < dataset.length; j++) {
                    if (dataset[j].title == dataset_links[i].origin || dataset[j].title == dataset_links[i].termination) {
                        if (dataset[j].group == 2) {
                            dataset_links[i].line_opaque = 0;
                        }
                    }
                }
            }
        }



        function resetGroups() {
            // function which loops through dataset
            // and resets all Gaps to 0 and Systematic reviews to 1
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title.substring(0, 1) == "S") {
                    dataset[i].group = 1;
                } else if (dataset[i].title.substring(0, 1) == "G") {
                    dataset[i].group = 0;
                }
            }
            for (i = 0; i < dataset_links.length; i++) {
                dataset_links[i].line_opaque = 1;
            }
        }

        function popupString(this_var, link) {
            // function to popup the rectangles with the strings in
            // in this version it is just on the right
            var coords = [0, 0];
            coords = d3.mouse(this_var);

            //left rectangle:-
            var rectangle = svg.append("rect")
                .attr("x", 2)
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h);
                    } else {
                        return (coords[1]);
                    }
                })
                .attr("width", popup_w)
                .attr("height", popup_h)
                .attr("fill", left_lighter_colour)
                .attr("rx", 20)
                .attr("ry", 20)
                .attr("id", "popup-string-id")
                .style("pointer-events", "none");
            // insert text on the left:
            var ldx = 10;
            var leftText = svg.append("text")
                .attr('style', 'text-align:left; font-family:Helvetica; font-size:15px;')
                .attr('id', 'multiline-left-text')
                .attr("x", ldx)
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h + 30);
                    } else {
                        return (coords[1] + 30);
                    }
                })
                .text(""); // empty text instead of a placeholder
            var new_text = "";
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title == link.origin) {
                    new_text = dataset[i].full_title;
                    // console.log(new_text);
                    // console.log("Left node = ");
                    // console.log(dataset[i].title);
                }
            }
            createMultiLineLeft("Research: ".concat(new_text), ldx);

            // right rectangle
            var rectangle = svg.append("rect")
                .attr("x", w - (popup_w + 2))
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h);
                    } else {
                        return (coords[1]);
                    }
                })
                .attr("width", (popup_w))
                .attr("height", (popup_h))
                .attr("fill", right_lighter_colour)
                .attr("rx", 20)
                .attr("ry", 20)
                .attr("id", "popup-string-id")
                .style("pointer-events", "none");

            var dx = w - (popup_w - 10);
            var rightText = svg.append("text")
                .attr('style', 'text-align:left; font-family:Helvetica; font-size:15px;')
                .attr('id', 'multiline-right-text')
                .attr("x", dx)
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h + 30);
                    } else {
                        return (coords[1] + 30);
                    }
                })
                .attr("width", popup_w - 10)
                .attr("height", popup_h)
                .text("");
            var new_text = "";
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title == link.termination) {
                    new_text = dataset[i].full_title;
                    // console.log("Right node = ")
                    // console.log(dataset[i].title);
                }
            }
            createMultiLineRight("Topic: ".concat(new_text), dx);

            // reason in the middle!!

            var rectangle = svg.append("rect")
                .attr("x", w / 2 - (popup_w * .5 / 2))
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h * 1.6);
                    } else {
                        return (coords[1]);
                    }
                })
                .attr("width", (popup_w * .5))
                .attr("height", (popup_h * 1.6))
                .attr("fill", link_standard_colour)
                .attr("rx", 20)
                .attr("ry", 20)
                .attr("id", "popup-string-id")
                .style("pointer-events", "none");

            var mdx = w / 2 - (popup_w * .5 / 2) + 10;

            var middleText = svg.append("text")
                .attr('style', 'text-align:left; font-family:Helvetica; font-size:10px;')
                .attr('id', 'multiline-middle-text')
                .attr("x", mdx)
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h * 1.6 + 30);
                    } else {
                        return (coords[1] + 30);
                    }
                })
                .attr("width", popup_w - 10)
                .attr("height", popup_h)
                .text("");
            var new_text = "";
            //console.log(new_text);
            // console.log("link.termination = ")
            //console.log(link.termination);
            for (i = 0; i < dataset.length; i++) {
                if (dataset[i].title == link.origin) {
                    // console.log("Middle node identified.  The next three logs should be dataset[i].title and dataset[i].recommend and i.");
                    //console.log(dataset[i].title);
                    //console.log(dataset[i].recommend);
                    //console.log(i);
                    new_text = dataset[i].recommend;
                }
            }
            //console.log(new_text);
            createMultiLineMiddle(new_text, mdx);

        }

        function createMultiLineMiddle(text, mdx) {
            var words = text.split(' ');

            // Get dimensions of the rectangle
            var text_width = popup_w * .5 - 20;
            var rectangle_height = popup_h * 1.6; // Match the height of the middle rectangle
            var line_height = 18; // Height of each line of text
            var initial_y_offset = 30; // Initial y position where text starts
            
            // Calculate maximum number of lines that can fit in the rectangle
            var max_lines = Math.floor((rectangle_height - initial_y_offset) / line_height);
            
            var text_element = document.getElementById("multiline-middle-text");
            text_element.textContent = "";
            text_element.setAttribute('style', 'text-align:left; font-family:Helvetica; font-weight:bold; font-size:12px;')
            
            // Create first tspan element
            var current_tspan = document.createElementNS(svgNS, "tspan");
            var text_node = document.createTextNode(words[0] || "");
            
            current_tspan.appendChild(text_node);
            text_element.appendChild(current_tspan);

            var lines_count = 0;
            
            for (var i = 1; i < words.length; i++) {
                // Store current length before adding new word
                var len = current_tspan.firstChild.data.length;
                
                // Try adding the next word
                current_tspan.firstChild.data += " " + words[i];
                
                // Check if it's too long for the width
                if (current_tspan.getComputedTextLength() > text_width) {
                    // Remove the added word (restore to previous length)
                    current_tspan.firstChild.data = current_tspan.firstChild.data.slice(0, len);
                    
                    // Increment line count
                    lines_count += 1;
                    
                    // Check if we've hit the maximum number of lines that can fit
                    if (lines_count >= max_lines - 1) { // Leave one line for ellipsis
                        // Add ellipsis to indicate truncation
                        current_tspan.firstChild.data += "...";
                        break; // Stop processing more words
                    }
                    
                    // Create a new tspan for the next line
                    var next_tspan = document.createElementNS(svgNS, "tspan");
                    next_tspan.setAttributeNS(null, "x", mdx);
                    next_tspan.setAttributeNS(null, "dy", line_height);
                    
                    // Add the current word to the new line
                    var new_text_node = document.createTextNode(words[i]);
                    next_tspan.appendChild(new_text_node);
                    text_element.appendChild(next_tspan);
                    
                    // Update the current tspan reference
                    current_tspan = next_tspan;
                }
            }
        }
        function createMultiLineLeft(text, ldx) {
            // Handle null or empty text
            if (!text || text.trim() === "") {
                text = ""; // Set to empty string
            }
            var words = text.split(' ');

            var text_width = popup_w - 20;
            var text_element = document.getElementById("multiline-left-text");
            text_element.textContent = "";
            text_element.setAttribute('style', 'text-align:left; font-family:Helvetica; font-size:20px;')
            var tspan_element = document.createElementNS(svgNS, "tspan");   // Create first tspan element
            var text_node = document.createTextNode(words[0]);           // Create text in tspan element

            tspan_element.appendChild(text_node);                           // Add tspan element to DOM
            text_element.appendChild(tspan_element);

            var lines_count = 0;  // this variable sets how many lines high it can be
            for (var i = 1; i < words.length; i++) {

                var len = tspan_element.firstChild.data.length;             // Find number of letters in string
                tspan_element.firstChild.data += " " + words[i];            // Add next word

                if (tspan_element.getComputedTextLength() > text_width) {
                    tspan_element.firstChild.data = tspan_element.firstChild.data.slice(0, len); 				// Remove added word
                    lines_count = lines_count + 1;
                    if (lines_count > 13) {
                        tspan_element.firstChild.data = tspan_element.firstChild.data.slice(0, len);  // remove another word
                        tspan_element.firstChild.data += "...";  // add '...'
                        break; // break out of the for loop
                    }
                    var tspan_element = document.createElementNS(svgNS, "tspan");				// Create new tspan element
                    tspan_element.setAttributeNS(null, "x", ldx);
                    tspan_element.setAttributeNS(null, "dy", 20);
                    text_node = document.createTextNode(words[i]);
                    tspan_element.appendChild(text_node);
                    text_element.appendChild(tspan_element);

                }
            }
        }

        function createMultiLineRight(text, dx) {
            var words = text.split(' ');

            var text_width = popup_w - 20;
            var text_element = document.getElementById("multiline-right-text");
            text_element.setAttribute('style', 'text-align:left; font-family:Helvetica; font-size:20px;')
            text_element.textContent = "";
            var tspan_element = document.createElementNS(svgNS, "tspan");   // Create first tspan element
            var text_node = document.createTextNode(words[0]);           // Create text in tspan element

            tspan_element.appendChild(text_node);                           // Add tspan element to DOM
            text_element.appendChild(tspan_element);
            var lines_count = 0;
            for (var i = 1; i < words.length; i++) {
                var len = tspan_element.firstChild.data.length;             // Find number of letters in string
                tspan_element.firstChild.data += " " + words[i];            // Add next word

                if (tspan_element.getComputedTextLength() > text_width) {
                    lines_count = lines_count + 1;
                    if (lines_count > 13) {
                        tspan_element.firstChild.data = tspan_element.firstChild.data.slice(0, len);  // remove another word
                        tspan_element.firstChild.data += "...";  // add '...'
                        break; // break out of the for loop
                    }
                    tspan_element.firstChild.data = tspan_element.firstChild.data.slice(0, len);    // Remove added word
                    var tspan_element = document.createElementNS(svgNS, "tspan");       // Create new tspan element
                    tspan_element.setAttributeNS(null, "x", dx);
                    tspan_element.setAttributeNS(null, "dy", 20);
                    text_node = document.createTextNode(words[i]);
                    tspan_element.appendChild(text_node);
                    text_element.appendChild(tspan_element);
                }
            }
        }

        function popupTitle(this_var, title, group, full_title) {
            // function to popup the title of the 
            var coords = [0, 0];
            coords = d3.mouse(this_var);
            var dx = 20;
            var dy = 0;
            // we could use this code below to determine if this is a left node or a right node 
            // swapping height for width
            if (coords[1] > h / 2) {
                dy = 20;
            } else {
                dy = h - 120; // height = 100
            }

            // left rectangle
            var rectangle = svg.append("rect")
                .attr("x", 2)
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h);
                    } else {
                        return (coords[1]);
                    }
                })
                .attr("width", popup_w)
                .attr("height", popup_h)
                .attr("fill", left_lighter_colour)
                .attr("rx", 20)
                .attr("ry", 20)
                .attr("id", "popup-string-id")
                .style("pointer-events", "none");

            // insert text on the left 
            var ldx = 10;
            var leftText = svg.append("text")
                .attr('style', 'text-align:left; font-family:Helvetica; font-size:15px;')
                .attr('id', 'multiline-left-text')
                .attr("x", ldx)
                .attr("y", function () {
                    if (coords[1] > h / 2) {
                        return (coords[1] - popup_h + 30);
                    } else {
                        return (coords[1] + 30);
                    }
                })
                .text("");
            var new_text = "";
            // console.log("full_title:");
            //console.log(full_title);
            // console.log("new_text:")
            //console.log(new_text);
            new_text = full_title;
            //console.log(new_text);
            createMultiLineLeft("Research: ".concat(new_text), ldx);
        }

        function createPopup(text, dx) {
            var words = text.split(' ');
            var text_width = w - 100;
            var text_element = document.getElementById("multiline-title-text");
            text_element.textContent = "";
            text_element.setAttribute('style', 'font-family:Helvetica; font-size:20px;')
            var tspan_element = document.createElementNS(svgNS, "tspan");   // Create first tspan element
            var text_node = document.createTextNode(words[0]);           // Create text in tspan element

            tspan_element.appendChild(text_node);                           // Add tspan element to DOM
            text_element.appendChild(tspan_element);

            var lines_count = 0;  // this variable sets how many lines high it can be
            for (var i = 1; i < words.length; i++) {
                var len = tspan_element.firstChild.data.length;             // Find number of letters in string
                tspan_element.firstChild.data += " " + words[i];            // Add next word

                if (tspan_element.getComputedTextLength() > text_width) {
                    tspan_element.firstChild.data = tspan_element.firstChild.data.slice(0, len); 				// Remove added word
                    lines_count = lines_count + 1;
                    if (lines_count > 5) {  //don't go over this number of lines
                        tspan_element.firstChild.data = tspan_element.firstChild.data.slice(0, len);  // remove another word
                        tspan_element.firstChild.data += "...";  // add '...'
                        break; // break out of the for loop
                    }
                    var tspan_element = document.createElementNS(svgNS, "tspan");				// Create new tspan element
                    tspan_element.setAttributeNS(null, "x", dx);
                    tspan_element.setAttributeNS(null, "dy", 20);
                    text_node = document.createTextNode(words[i]);
                    tspan_element.appendChild(text_node);
                    text_element.appendChild(tspan_element);

                }
            }
        }

        function removeBottomText() {
            var element = document.getElementById("bottom_text");
            if (element != null) {
                element.parentNode.removeChild(element);
            }
        }

        function removePopup() {
            svg.selectAll("rect").remove();
            var element = document.getElementById("multiline-title-text");
            element.parentNode.removeChild(element);
        }

        function removePopupMain() {
            // this removes the popups from the main function
            var element = document.getElementById("multiline-title-text");
            if (element != null) {
                element.parentNode.removeChild(element);
            }
            var element_exists = 1;
            var i = 0;
            while (element_exists == 1) {
                i = i + 1;
                var element = document.getElementById("popup-title-id");
                if (element != null) {
                    //console.log(i);
                    element.parentNode.removeChild(element);
                } else {
                    element_exists = 0;
                    // console.log("in removePopupMain... no popups left")
                }
            }
        }

        function removeString() {
            //do stuff to remove all the popup strings on the page
            svg.selectAll("foreignObject").remove();
            svg.selectAll("xhtml").remove();
            var element = document.getElementById("multiline-right-text");
            if (element != null) {
                element.parentNode.removeChild(element);
            }
            var element = document.getElementById("multiline-left-text");
            if (element != null) {
                element.parentNode.removeChild(element);
            }
            var element = document.getElementById("multiline-middle-text");
            if (element != null) {
                element.parentNode.removeChild(element);
            }
            var element_exists = 1;
            var i = 0;
            while (element_exists == 1) {
                i = i + 1;
                var element = document.getElementById("popup-string-id");
                if (element != null) {
                    //console.log(i);
                    element.parentNode.removeChild(element);
                } else {
                    element_exists = 0;
                    // console.log("in removeString... no popups left")
                }
            }
        }

 

        function drawButton(y_pos, button_text, function_call, fcol, fontcol) {
            // Default colors if not provided
            fontcol = (typeof fontcol !== 'undefined') ? fontcol : "black";
            fcol = (typeof fcol !== 'undefined') ? fcol : Antibiotic_therapy_col;

            // Create a group to hold both rectangle and text
            var buttonGroup = svg.append("g")
                .attr("class", "button-group");
            
            // Add rectangle to group
            var button_rect = buttonGroup.append("rect")
                .attr("x", 0)
                .attr("y", y_pos + 5)
                .attr("width", button_width)
                .attr("height", 25)
                .attr("fill", fcol)
                .attr("stroke", "gray")
                .attr("rx", 5)
                .attr("ry", 5)
                .on("click", function () {
                    eval(function_call);
                })
                .on("mouseover", function() {
                    // Highlight effect on mouseover
                    d3.select(this)
                        .attr("stroke", "#333333")
                        .attr("stroke-width", 2);
                        
                    // Also highlight the text
                    d3.select(this.parentNode).select('text')
                        .attr('style', 'text-align:center; font-family:Helvetica; font-size:14px; font-weight:bold; fill:' + fontcol);
                })
                .on("mouseout", function() {
                    // Return to original style on mouseout
                    d3.select(this)
                        .attr("stroke", "gray")
                        .attr("stroke-width", 1);
                        
                    // Return text to normal
                    d3.select(this.parentNode).select('text')
                        .attr('style', 'text-align:center; font-family:Helvetica; font-size:14px; font-weight:normal; fill:' + fontcol);
                });

            // Add text to the same group
            var button_text = buttonGroup.append("text")
                .attr('style', 'text-align:center; font-family:Helvetica; font-size:14px; font-weight:normal; fill:' + fontcol)
                .attr("x", 5)
                .attr("y", y_pos + 5 + 14)
                .attr('id', 'button_text')
                .text(function (d) {
                    return (button_text);
                })
                .style("cursor", "default")
                .on("click", function () {
                    eval(function_call);
                })
                .on("mouseover", function() {
                    // Highlight the rectangle when text is hovered
                    d3.select(this.parentNode).select('rect')
                        .attr("stroke", "#333333")
                        .attr("stroke-width", 2);
                        
                    // Update text style
                    d3.select(this)
                        .attr('style', 'text-align:center; font-family:Helvetica; font-size:14px; font-weight:bold; fill:' + fontcol);
                })
                .on("mouseout", function() {
                    // Return rectangle to original style
                    d3.select(this.parentNode).select('rect')
                        .attr("stroke", "gray")
                        .attr("stroke-width", 1);    
                        
                    // Return text to original style
                    d3.select(this)
                        .attr('style', 'text-align:center; font-family:Helvetica; font-size:14px; font-weight:normal; fill:' + fontcol);
                });
        }


        function drawAllButtons() {
            var z = 0;
            var big_space = 30;
            var small_space = 26;

            var uniqueTopics = []; // Array to store unique topics

            for (var i = 0; i < dataset_links.length; i++) {
                var topic = dataset_links[i].topic;
                var buttonText = dataset_links[i].topic;
                var onClickAction = "getTopic('" + topic + "');";

                if (!uniqueTopics.includes(topic)) {
                    // Draw the button only if the topic is not already included
                    drawButton(z, buttonText, onClickAction, "white");
                    uniqueTopics.push(topic); // Add the topic to the uniqueTopics array
                    z = z + small_space;
                }
            }

            z = z + big_space;
            drawButton(z, "Reset", "showAllCircle();", "white");
            z = z + big_space;
        }


        function setLineStyle() {
            // function to loop over the links and set the line style
            // console.log("in setLineStyle")
            for (i = 0; i < dataset_links.length; i++) {
                if (dataset_links[i].commission == "No Trials") {
                    dataset_links[i].line_style = 2;
                }
            }
        }

        function getTopicForNode(nodeTitle) {
            // Search through dataset_links to find the topic
            for (let i = 0; i < dataset_links.length; i++) {
                // If this link points to the node we're looking for
                if (dataset_links[i].termination == nodeTitle) {
                    // Return the topic of this link
                    return dataset_links[i].topic;
                }
            }
            // If no topic was found
            return null;
        }

        function runFigure() {
            removeBottomText();
            drawAllButtons();
            setLineStyle();

            svg.selectAll("circle")
                .data(dataset) //may as well use this as the index
                .enter()
                .append("circle")
                .attr("id", "nodes")
                .attr("cx", function (d) {
                    return (d.x_coord);
                })
                .attr("cy", function (d) {
                    return (d.y_coord);
                })
                .attr("r", function (d, i) {
                    d.rad = Math.sqrt(dataset[i].size * circle_radius)
                    return (d.rad);
                })
                .attr("stroke-width", 2)
                .attr("fill", function (d, i) {
                    if (dataset[i].group == 0) {
                        return (left_inner_colour);
                    } else {
                        return (right_inner_colour);
                    }
                })
                .attr("stroke", function (d, i) {
                    if (dataset[i].group == 0) {
                        return (left_outer_colour);
                    } else {
                        return (right_outer_colour);
                    }
                })
                .on("click", function (d, i) {
                    if (dataset[i].group == 0) {
                        //console.log(dataset[i].title);
                        //console.log(dataset[i].recommend);
                        window.open((dataset[i].doi));
                    } else if (dataset[i].group == 1) {
                        // console.log("click detected - datset[i]==1");
                        //console.log(dataset[i].title);
                        // work out the topic 
                        var nodeTopic = getTopicForNode(dataset[i].title);
                        // console.log("node topic = ")
                        //console.log(nodeTopic)
                        if (nodeTopic) {
                            // Call the getTopic function with this topic
                            getTopic(nodeTopic);
                        }

                    }
                })
                .on("mouseover", function () {
                    d3.select(this)
                        .attr("fill", function (d) {
                            // logic to fill the circle and call
                            // highlight nodes and write text
                            highlightNodes(d.title);
                            popupTitle(this, d.title, d.group, d.full_title);
                            // console.log("Node = ");
                            //console.log(d.title);
                            if (d.group == 0) {
                                return (left_outer_colour);
                            } else {
                                return (right_outer_colour);
                            }
                        })

                })
                .on("mouseout", function () {
                    var thisElement = this;
                    setTimeout(function() {
                        d3.select(thisElement)
                        .attr("fill", function (d) {
                            removeString();
                            unhighlightNodes();
                            removePopupMain();
                            if (d.group == 0) {
                                return (left_inner_colour);
                            } else {
                                return (right_inner_colour);
                            }
                            });
                    }, 50); // 50ms delay
                });



            svg.selectAll("path")
                .data(dataset_links) //may as well use this as the index
                .enter()
                .append("path")
                .attr("d", diagonal)
                .attr("id", "links")
                .style("stroke-linecap", "round")
                .style("fill", "none")
                .style("stroke", function (d) {
                    if (d.line_opaque == 0) {
                        return (link_transparent_colour);
                    } else if (d.line_col == 1 && d.agreement == 1) {
                        return (link_standard_colour);
                    } else if (d.line_col == 1 && d.agreement == 4) {
                        return (link_standard_colour_disagree);
                    } else if (d.line_col == 0 && d.agreement == 1) {
                        return (link_faded_colour);
                    } else if (d.line_col == 0 && d.agreement == 4) {
                        return (link_faded_colour_disagree);
                    } else if (d.line_col == 2 && d.agreement == 1) {
                        return (link_highlight_colour);
                    } else if (d.line_col == 2 && d.agreement == 4) {
                        return (link_highlight_colour_disagree);
                    } else {
                        return ("blue");
                    }
                })
                .style("stroke-dasharray", function (d) {
                    if (d.line_style == 1) {
                        return ("5, 0");
                    } else if (d.line_style == 2) {
                        return (line_dashed);
                    }
                })
                .style("stroke-width", line_width)
                .on("mouseover", function () {
                    // don't do mouse overs if the line is transparent!
                    d3.select(this)
                        .style("stroke", function (d) {
                            if (d.line_opaque == 0) {
                                return (link_transparent_colour);
                            }
                            popupString(this, d);
                            // highlightLinks(d);
                            fadeAllLinks();
                            if (d.agreement == 1) {
                                return (link_highlight_colour);
                            } else if (d.agreement == 4) {
                                return (link_highlight_colour_disagree);
                            }
                        })
                })
                .on("mouseout", function () {
                    var thisElement = this;
                    // don't do mouse overs if the line is transparent!
                    setTimeout(function() {
                        d3.select(thisElement)
                        .style("stroke", function (d) {
                            if (d.line_opaque == 0) {
                                return (link_transparent_colour);
                            }
                            removeString();
                            unhighlightNodes();
                            if (d.line_col == 1 && d.agreement == 1) {
                                return (link_standard_colour);
                            } else if (d.line_col == 1 && d.agreement == 4) {
                                return (link_standard_colour_disagree);
                            } else if (d.line_col == 0 && d.agreement == 1) {
                                return (link_faded_colour);
                            } else if (d.line_col == 0 && d.agreement == 4) {
                                return (link_faded_colour_disagree);
                            } else if (d.line_col == 2 && d.agreement == 1) {
                                return (link_highlight_colour);
                            } else if (d.line_col == 2 && d.agreement == 4) {
                                return (link_highlight_colour_disagree);
                            } else {
                                return ("blue");
                            }
                        })
                    }, 50) // this is the delay of 50 ms
                });
        }

        //Functions to download the data:
        // Function to read and parse the XLSX file
        function importXLSX(file, callback) {
            var reader = new FileReader();

            reader.onload = function (event) {
                var data = new Uint8Array(event.target.result);
                var workbook = XLSX.read(data, { type: "array" });
                var worksheet = workbook.Sheets[workbook.SheetNames[0]];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                var headers = jsonData[0]; // Extract the first row as headers
                var dataArray = jsonData.slice(1); // Remove the first row from the data

                var result = dataArray.map(function (row) {
                    var obj = {};
                    headers.forEach(function (header, index) {
                        obj[header] = row[index];
                    });
                    return obj;
                });

                callback(result);
            };

            reader.readAsArrayBuffer(file);
        }

        // Handle file selection event for dataset file
        function handledatasetFileSelect(event) {
            var file = event.target.files[0];
            importXLSX(file, function (jsonData) {
                dataset = jsonData; // Store dataset data in the 'dataset' variable
                hideFileInput('datasetButton');
            });
        }

        // Handle file selection event for dataset_links file
        function handledataset_linksFileSelect(event) {
            var file = event.target.files[0];
            importXLSX(file, function (jsonData) {
                dataset_links = jsonData; // Store dataset_links data in the 'dataset_links' variable
                hideFileInput('dataset_linksButton');
            });
        }

        // Function to hide button element by ID
        function hideFileInput(buttonId) {
            var button = d3.select("#" + buttonId);
            button.style("display", "none");
        }

        // Function to trigger file input click event
        function triggerFileInputClick(inputId) {
            var fileInput = document.getElementById(inputId);
            fileInput.click();
        }

        // Create D3 button for file input
        function createFileInputButton(buttonId, inputId, buttonText) {
            var buttonContainer = d3.select("body")
                .append("div")
                .attr("id", buttonId)
                .attr("class", "custom-button-container");

            buttonContainer.append("button")
                .attr("class", "custom-button")
                .text(buttonText)
                .on("click", function () {
                    triggerFileInputClick(inputId);
                });

            buttonContainer.append("input")
                .attr("type", "file")
                .attr("id", inputId)
                .attr("class", "hidden")
                .on("change", function () {
                    if (inputId === "datasetFileInput") {
                        handledatasetFileSelect(event); // Pass the event parameter here
                    } else if (inputId === "dataset_linksFileInput") {
                        handledataset_linksFileSelect(event); // Pass the event parameter here
                    }
                });
        }

        async function loadXLSXData() {
            // Create file input buttons using D3
            createFileInputButton("datasetButton", "datasetFileInput", "Load dataset");
            createFileInputButton("dataset_linksButton", "dataset_linksFileInput", "Load dataset_links");

            await waitForArrays();
        }

        function logEvent() {
            // console.log("Event");
            // console.log("dataset:", dataset);
            // console.log("dataset_links:", dataset_links);
        }

        function waitForArrays() {
            return new Promise((resolve) => {
                // Function to check if both arrays have data
                function checkArrays() {
                    if (dataset.length > 0 && dataset_links.length > 0) {
                        resolve(); // Resolve the promise when both arrays have data
                    } else {
                        setTimeout(checkArrays, 100); // Check again after a certain delay
                    }
                }

                checkArrays(); // Start checking the arrays
            });
        }

        //  //  //  //  //  //  //  //
        ///  CODE TO GET THINGS DONE:


        async function main() {

            console.log("in the main function");
    
            // Check if dataset and dataset_links already have data (are hardcoded)
            if (dataset.length > 0 && dataset_links.length > 0) {
                console.log("Using hardcoded dataset and dataset_links");
                button_width = calculateMaxButtonWidth();
                // Skip loading data files, directly update groups and display
                update_groups();
                setCircleArrangement();
                runFigure();
            } else {
                // No hardcoded data, proceed with loading data files
                console.log("No hardcoded data found. Loading data from files...");
                await loadXLSXData();  // Load data before drawing anything
                button_width = calculateMaxButtonWidth();
                logEvent();  // Log to help track program flow
                update_groups();
                setCircleArrangement();
                runFigure();
            }
        }

        main();  // and here it is that we start!
    </script>
</body>

</html>